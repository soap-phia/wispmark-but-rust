name: Build and Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag'
        required: true
        type: string
      release_name:
        description: 'Release name'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu

      - name: Install Cross-Compilation Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure Linker
        run: |
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-gnu]' > .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Build
        run: |
          bun run build:amd64
          bun run build:arm64

      - name: Prepare Distribution
        run: |
          mkdir -p ship/amd64 ship/arm64
          
          # Copy artifacts (assuming build:all puts them in dist/)
          cp -r dist/amd64/* ship/amd64/
          cp -r dist/arm64/* ship/arm64/

          # Remove forbidden files/folders from the ship directory
          find ship -type f \( -name ".*" -o -name "package.json" -o -name "bun.lock" -o -name "cargo.lock" -o -name "cargo.toml" \) -delete
          find ship -type d \( -name ".*" -o -name "src" -o -name "repos" \) -exec rm -rf {} +

          # Zip for release
          cd ship
          zip -r ../dist/build-amd64.zip amd64
          zip -r ../dist/build-arm64.zip arm64

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ inputs.tag }}
          name: ${{ inputs.release_name }}
          artifacts: "dist/*.zip"
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: true
          body: |
            **Tag:** `${{ inputs.tag }}`
            **Commit:** ${{ github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}